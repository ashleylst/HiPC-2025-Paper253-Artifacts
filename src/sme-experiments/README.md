# ARM SME experiments

## performance:

see [`performance_modeling.md`](performance_modeling.md)

## new driver:

Cross-compile from x86 with ARM BLIS in `~/Software/aarch64/blis`:
```
$ aarch64-linux-gnu-g++ -std=c++23 -march=armv8-a+sve+sme-f64f64 -static -O3 -ffast-math -I ~/Software/aarch64/blis/include -L ~/Software/aarch64/blis/lib -o mm3x3t3xN driver.cpp mm3x3*cpp -lblis -fopenmp

```

Run:
```
$ ./mm3x3t3xN <N> <method>
```
where `<N>` is the number of vectors and `<method>` is one of `cpp|blas|sme_nega1|sme_nega8|sme_negb`

- `cpp`: auto-vectorized c++ version
- `blas`: `cblas_zgemm` call
- `sme_nega1`: 1x tile neg-a ARM SME version
- `sme_nega8`: 8x tile neg-a ARM SME version
- `sme_negb`: 1x tile neg-b ARM SME version


Run with QEMU:
```
$ qemu-aarch64-static -cpu max,sve512=on,sme512=on mm3x3t3xN 8 cpp
                                   B:
                                         0+0.3i    0.6+0.9i    1.2+1.5i    1.8+2.1i    2.4+2.7i      3+3.3i    3.6+3.9i    4.2+4.5i
                                       4.8+5.1i    5.4+5.7i      6+6.3i    6.6+6.9i    7.2+7.5i    7.8+8.1i    8.4+8.7i      9+9.3i
                                       9.6+9.9i  10.2+10.5i  10.8+11.1i  11.4+11.7i    12+12.3i  12.6+12.9i  13.2+13.5i  13.8+14.1i
A:
      0+0.3i    1.8+2.1i    3.6+3.9i
    0.6+0.9i    2.4+2.7i    4.2+4.5i
    1.2+1.5i      3+3.3i    4.8+5.1i
                                   C:
                                     -6.21+92.34i  -6.75+99.36i  -7.29+106.38i  -7.83+113.4i  -8.37+120.42i  -8.91+127.44i  -9.45+134.46i  -9.99+141.48i
                                     -6.75+110.16i  -7.29+119.34i  -7.83+128.52i  -8.37+137.7i  -8.91+146.88i  -9.45+156.06i  -9.99+165.24i  -10.53+174.42i
                                     -7.29+127.98i  -7.83+139.32i  -8.37+150.66i  -8.91+162i  -9.45+173.34i  -9.99+184.68i  -10.53+196.02i  -11.07+207.36i

```

Instruction counting with QEMU and insn TCG plugin:

```
$ qemu-aarch64-static -cpu max,sve512=on,sme512=on \
 -plugin $QEMU_BUILD_DIR/tests/tcg/plugins/libinsn.so,match=fmla\ z,match=fmla\ d,match=fmla\ v,match=fmls\ z,match=fmls\ d,match=fmls\ v,match=fmul\ z,match=fmul\ d,match=fmul\ v,match=fneg,match=revd,match=mov\ z,match=mova\ z,match=ldr\ d,match=str\ d,match=ld1rd\ {z,match=ld1d\ {z,match=ld2d\ {z,match=st1d\ {z,match=st2d\ {z,match=fmopa\ z,match=fmadd,match=fmsub \
 -d plugin \
 mm3x3t3xN 8 blas 2>&1 | grep  "Match:\|insns"
cpu 0 insns: 1159929
total insns: 1159929
Match: fmla z, hits 96
Match: fmla d, hits 0
Match: fmla v, hits 0
Match: fmls z, hits 30
Match: fmls d, hits 0
Match: fmls v, hits 0
Match: fmul z, hits 29
Match: fmul d, hits 40
Match: fmul v, hits 0
Match: fneg, hits 1
Match: revd, hits 0
Match: mov z, hits 61
Match: mova z, hits 0
Match: ldr d, hits 672
Match: str d, hits 395
Match: ld1rd {z, hits 74
Match: ld1d {z, hits 0
Match: ld2d {z, hits 20
Match: st1d {z, hits 27
Match: st2d {z, hits 29
Match: fmopa z, hits 0
Match: fmadd, hits 6
Match: fmsub, hits 0
```

## old driver:

Cross-compile from x86 with ARM BLIS in `~/Software/aarch64/blis`:
```
$ aarch64-linux-gnu-g++ -march=armv8-a+sme-f64f64 -static -O3 -ffast-math -I ~/Software/aarch64/blis/include -L ~/Software/aarch64/blis/lib -o fmopa_mm3x3t3xN fmopa_mm3x3t3xN.cpp -lblis -fopenmp
```

Or normal compile on ARM machine with BLIS installed in /usr:
```
$ g++ -march=armv8-a+sme-f64f64 -static -O3 -ffast-math -o fmopa_mm3x3t3xN fmopa_mm3x3t3xN.cpp -lblis -fopenmp
```

Run with qemu:

specific SME/fmopa implementation will be selected automatically based on VLEN and N

sme256bit,N=4:
```
$ qemu-aarch64-static -cpu max,sve256=on,sme256=on fmopa_mm3x3t3xN 4
                                   B:
                                         0+0.3i    0.6+0.9i    1.2+1.5i    1.8+2.1i
                                       2.4+2.7i      3+3.3i    3.6+3.9i    4.2+4.5i
                                       4.8+5.1i    5.4+5.7i      6+6.3i    6.6+6.9i
A:
        0+1i        6+7i      12+13i
        2+3i        8+9i      14+15i
        4+5i      10+11i      16+17i
                                   C (reference):
                                     -13.5+156.6i  -15.3+180i  -17.1+203.4i  -18.9+226.8i
                                     -15.3+187.2i  -17.1+217.8i  -18.9+248.4i  -20.7+279i
                                     -17.1+217.8i  -18.9+255.6i  -20.7+293.4i  -22.5+331.2i
Computing using neg-b version
                                   C (ours):
                                     -13.5+156.6i  -15.3+180i  -17.1+203.4i  -18.9+226.8i
                                     -15.3+187.2i  -17.1+217.8i  -18.9+248.4i  -20.7+279i
                                     -17.1+217.8i  -18.9+255.6i  -20.7+293.4i  -22.5+331.2i
```

sme256bit,N=8:
```
$ qemu-aarch64-static -cpu max,sve256=on,sme256=on fmopa_mm3x3t3xN 8
                                   B:
                                         0+0.3i    0.6+0.9i    1.2+1.5i    1.8+2.1i    2.4+2.7i      3+3.3i    3.6+3.9i    4.2+4.5i
                                       4.8+5.1i    5.4+5.7i      6+6.3i    6.6+6.9i    7.2+7.5i    7.8+8.1i    8.4+8.7i      9+9.3i
                                       9.6+9.9i  10.2+10.5i  10.8+11.1i  11.4+11.7i    12+12.3i  12.6+12.9i  13.2+13.5i  13.8+14.1i
A:
        0+1i        6+7i      12+13i
        2+3i        8+9i      14+15i
        4+5i      10+11i      16+17i
                                   C (reference):
                                     -20.7+307.8i  -22.5+331.2i  -24.3+354.6i  -26.1+378i  -27.9+401.4i  -29.7+424.8i  -31.5+448.2i  -33.3+471.6i
                                     -22.5+367.2i  -24.3+397.8i  -26.1+428.4i  -27.9+459i  -29.7+489.6i  -31.5+520.2i  -33.3+550.8i  -35.1+581.4i
                                     -24.3+426.6i  -26.1+464.4i  -27.9+502.2i  -29.7+540i  -31.5+577.8i  -33.3+615.6i  -35.1+653.4i  -36.9+691.2i
Computing using neg-b version
                                   C (ours):
                                     -20.7+307.8i  -22.5+331.2i  -24.3+354.6i  -26.1+378i  -27.9+401.4i  -29.7+424.8i  -31.5+448.2i  -33.3+471.6i
                                     -22.5+367.2i  -24.3+397.8i  -26.1+428.4i  -27.9+459i  -29.7+489.6i  -31.5+520.2i  -33.3+550.8i  -35.1+581.4i
                                     -24.3+426.6i  -26.1+464.4i  -27.9+502.2i  -29.7+540i  -31.5+577.8i  -33.3+615.6i  -35.1+653.4i  -36.9+691.2i
```

sme512bit,N=8:
```
$ qemu-aarch64-static -cpu max,sve512=on,sme512=on fmopa_mm3x3t3xN 8
                                   B:
                                         0+0.3i    0.6+0.9i    1.2+1.5i    1.8+2.1i    2.4+2.7i      3+3.3i    3.6+3.9i    4.2+4.5i
                                       4.8+5.1i    5.4+5.7i      6+6.3i    6.6+6.9i    7.2+7.5i    7.8+8.1i    8.4+8.7i      9+9.3i
                                       9.6+9.9i  10.2+10.5i  10.8+11.1i  11.4+11.7i    12+12.3i  12.6+12.9i  13.2+13.5i  13.8+14.1i
A:
        0+1i        6+7i      12+13i
        2+3i        8+9i      14+15i
        4+5i      10+11i      16+17i
                                   C (reference):
                                     -20.7+307.8i  -22.5+331.2i  -24.3+354.6i  -26.1+378i  -27.9+401.4i  -29.7+424.8i  -31.5+448.2i  -33.3+471.6i
                                     -22.5+367.2i  -24.3+397.8i  -26.1+428.4i  -27.9+459i  -29.7+489.6i  -31.5+520.2i  -33.3+550.8i  -35.1+581.4i
                                     -24.3+426.6i  -26.1+464.4i  -27.9+502.2i  -29.7+540i  -31.5+577.8i  -33.3+615.6i  -35.1+653.4i  -36.9+691.2i
Computing using 1xtile neg-a version
                                   C (ours):
                                     -20.7+307.8i  -22.5+331.2i  -24.3+354.6i  -26.1+378i  -27.9+401.4i  -29.7+424.8i  -31.5+448.2i  -33.3+471.6i
                                     -22.5+367.2i  -24.3+397.8i  -26.1+428.4i  -27.9+459i  -29.7+489.6i  -31.5+520.2i  -33.3+550.8i  -35.1+581.4i
                                     -24.3+426.6i  -26.1+464.4i  -27.9+502.2i  -29.7+540i  -31.5+577.8i  -33.3+615.6i  -35.1+653.4i  -36.9+691.2i

```

sme512bit,N=64:
```
$ qemu-aarch64-static -cpu max,sve512=on,sme512=on fmopa_mm3x3t3xN 64
                                   B:
                                         0+0.3i    0.6+0.9i    1.2+1.5i    1.8+2.1i    2.4+2.7i      3+3.3i    3.6+3.9i    4.2+4.5i    4.8+5.1i    5.4+5.7i      6+6.3i    6.6+6.9i    7.2+7.5i    7.8+8.1i    8.4+8.7i      9+9.3i    9.6+9.9i  10.2+10.5i  10.8+11.1i  11.4+11.7i    12+12.3i  12.6+12.9i  13.2+13.5i  13.8+14.1i  14.4+14.7i    15+15.3i  15.6+15.9i  16.2+16.5i  16.8+17.1i  17.4+17.7i    18+18.3i  18.6+18.9i  19.2+19.5i  19.8+20.1i  20.4+20.7i    21+21.3i  21.6+21.9i  22.2+22.5i  22.8+23.1i  23.4+23.7i    24+24.3i  24.6+24.9i  25.2+25.5i  25.8+26.1i  26.4+26.7i    27+27.3i  27.6+27.9i  28.2+28.5i  28.8+29.1i  29.4+29.7i    30+30.3i  30.6+30.9i  31.2+31.5i  31.8+32.1i  32.4+32.7i    33+33.3i  33.6+33.9i  34.2+34.5i  34.8+35.1i  35.4+35.7i    36+36.3i  36.6+36.9i  37.2+37.5i  37.8+38.1i
                                     38.4+38.7i    39+39.3i  39.6+39.9i  40.2+40.5i  40.8+41.1i  41.4+41.7i    42+42.3i  42.6+42.9i  43.2+43.5i  43.8+44.1i  44.4+44.7i    45+45.3i  45.6+45.9i  46.2+46.5i  46.8+47.1i  47.4+47.7i    48+48.3i  48.6+48.9i  49.2+49.5i  49.8+50.1i  50.4+50.7i    51+51.3i  51.6+51.9i  52.2+52.5i  52.8+53.1i  53.4+53.7i    54+54.3i  54.6+54.9i  55.2+55.5i  55.8+56.1i  56.4+56.7i    57+57.3i  57.6+57.9i  58.2+58.5i  58.8+59.1i  59.4+59.7i    60+60.3i  60.6+60.9i  61.2+61.5i  61.8+62.1i  62.4+62.7i    63+63.3i  63.6+63.9i  64.2+64.5i  64.8+65.1i  65.4+65.7i    66+66.3i  66.6+66.9i  67.2+67.5i  67.8+68.1i  68.4+68.7i    69+69.3i  69.6+69.9i  70.2+70.5i  70.8+71.1i  71.4+71.7i    72+72.3i  72.6+72.9i  73.2+73.5i  73.8+74.1i  74.4+74.7i    75+75.3i  75.6+75.9i  76.2+76.5i
                                     76.8+77.1i  77.4+77.7i    78+78.3i  78.6+78.9i  79.2+79.5i  79.8+80.1i  80.4+80.7i    81+81.3i  81.6+81.9i  82.2+82.5i  82.8+83.1i  83.4+83.7i    84+84.3i  84.6+84.9i  85.2+85.5i  85.8+86.1i  86.4+86.7i    87+87.3i  87.6+87.9i  88.2+88.5i  88.8+89.1i  89.4+89.7i    90+90.3i  90.6+90.9i  91.2+91.5i  91.8+92.1i  92.4+92.7i    93+93.3i  93.6+93.9i  94.2+94.5i  94.8+95.1i  95.4+95.7i    96+96.3i  96.6+96.9i  97.2+97.5i  97.8+98.1i  98.4+98.7i    99+99.3i  99.6+99.9i  100.2+100.5i  100.8+101.1i  101.4+101.7i  102+102.3i  102.6+102.9i  103.2+103.5i  103.8+104.1i  104.4+104.7i  105+105.3i  105.6+105.9i  106.2+106.5i  106.8+107.1i  107.4+107.7i  108+108.3i  108.6+108.9i  109.2+109.5i  109.8+110.1i  110.4+110.7i  111+111.3i  111.6+111.9i  112.2+112.5i  112.8+113.1i  113.4+113.7i  114+114.3i  114.6+114.9i
A:
        0+1i        6+7i      12+13i
        2+3i        8+9i      14+15i
        4+5i      10+11i      16+17i
                                   C (reference):
                                     -121.5+2424.6i  -123.3+2448i  -125.1+2471.4i  -126.9+2494.8i  -128.7+2518.2i  -130.5+2541.6i  -132.3+2565i  -134.1+2588.4i  -135.9+2611.8i  -137.7+2635.2i  -139.5+2658.6i  -141.3+2682i  -143.1+2705.4i  -144.9+2728.8i  -146.7+2752.2i  -148.5+2775.6i  -150.3+2799i  -152.1+2822.4i  -153.9+2845.8i  -155.7+2869.2i  -157.5+2892.6i  -159.3+2916i  -161.1+2939.4i  -162.9+2962.8i  -164.7+2986.2i  -166.5+3009.6i  -168.3+3033i  -170.1+3056.4i  -171.9+3079.8i  -173.7+3103.2i  -175.5+3126.6i  -177.3+3150i  -179.1+3173.4i  -180.9+3196.8i  -182.7+3220.2i  -184.5+3243.6i  -186.3+3267i  -188.1+3290.4i  -189.9+3313.8i  -191.7+3337.2i  -193.5+3360.6i  -195.3+3384i  -197.1+3407.4i  -198.9+3430.8i  -200.7+3454.2i  -202.5+3477.6i  -204.3+3501i  -206.1+3524.4i  -207.9+3547.8i  -209.7+3571.2i  -211.5+3594.6i  -213.3+3618i  -215.1+3641.4i  -216.9+3664.8i  -218.7+3688.2i  -220.5+3711.6i  -222.3+3735i  -224.1+3758.4i  -225.9+3781.8i  -227.7+3805.2i  -229.5+3828.6i  -231.3+3852i  -233.1+3875.4i  -234.9+3898.8i
                                     -123.3+2887.2i  -125.1+2917.8i  -126.9+2948.4i  -128.7+2979i  -130.5+3009.6i  -132.3+3040.2i  -134.1+3070.8i  -135.9+3101.4i  -137.7+3132i  -139.5+3162.6i  -141.3+3193.2i  -143.1+3223.8i  -144.9+3254.4i  -146.7+3285i  -148.5+3315.6i  -150.3+3346.2i  -152.1+3376.8i  -153.9+3407.4i  -155.7+3438i  -157.5+3468.6i  -159.3+3499.2i  -161.1+3529.8i  -162.9+3560.4i  -164.7+3591i  -166.5+3621.6i  -168.3+3652.2i  -170.1+3682.8i  -171.9+3713.4i  -173.7+3744i  -175.5+3774.6i  -177.3+3805.2i  -179.1+3835.8i  -180.9+3866.4i  -182.7+3897i  -184.5+3927.6i  -186.3+3958.2i  -188.1+3988.8i  -189.9+4019.4i  -191.7+4050i  -193.5+4080.6i  -195.3+4111.2i  -197.1+4141.8i  -198.9+4172.4i  -200.7+4203i  -202.5+4233.6i  -204.3+4264.2i  -206.1+4294.8i  -207.9+4325.4i  -209.7+4356i  -211.5+4386.6i  -213.3+4417.2i  -215.1+4447.8i  -216.9+4478.4i  -218.7+4509i  -220.5+4539.6i  -222.3+4570.2i  -224.1+4600.8i  -225.9+4631.4i  -227.7+4662i  -229.5+4692.6i  -231.3+4723.2i  -233.1+4753.8i  -234.9+4784.4i  -236.7+4815i
                                     -125.1+3349.8i  -126.9+3387.6i  -128.7+3425.4i  -130.5+3463.2i  -132.3+3501i  -134.1+3538.8i  -135.9+3576.6i  -137.7+3614.4i  -139.5+3652.2i  -141.3+3690i  -143.1+3727.8i  -144.9+3765.6i  -146.7+3803.4i  -148.5+3841.2i  -150.3+3879i  -152.1+3916.8i  -153.9+3954.6i  -155.7+3992.4i  -157.5+4030.2i  -159.3+4068i  -161.1+4105.8i  -162.9+4143.6i  -164.7+4181.4i  -166.5+4219.2i  -168.3+4257i  -170.1+4294.8i  -171.9+4332.6i  -173.7+4370.4i  -175.5+4408.2i  -177.3+4446i  -179.1+4483.8i  -180.9+4521.6i  -182.7+4559.4i  -184.5+4597.2i  -186.3+4635i  -188.1+4672.8i  -189.9+4710.6i  -191.7+4748.4i  -193.5+4786.2i  -195.3+4824i  -197.1+4861.8i  -198.9+4899.6i  -200.7+4937.4i  -202.5+4975.2i  -204.3+5013i  -206.1+5050.8i  -207.9+5088.6i  -209.7+5126.4i  -211.5+5164.2i  -213.3+5202i  -215.1+5239.8i  -216.9+5277.6i  -218.7+5315.4i  -220.5+5353.2i  -222.3+5391i  -224.1+5428.8i  -225.9+5466.6i  -227.7+5504.4i  -229.5+5542.2i  -231.3+5580i  -233.1+5617.8i  -234.9+5655.6i  -236.7+5693.4i  -238.5+5731.2i
Computing using 8xtile neg-a version
                                   C (ours):
                                     -121.5+2424.6i  -123.3+2448i  -125.1+2471.4i  -126.9+2494.8i  -128.7+2518.2i  -130.5+2541.6i  -132.3+2565i  -134.1+2588.4i  -135.9+2611.8i  -137.7+2635.2i  -139.5+2658.6i  -141.3+2682i  -143.1+2705.4i  -144.9+2728.8i  -146.7+2752.2i  -148.5+2775.6i  -150.3+2799i  -152.1+2822.4i  -153.9+2845.8i  -155.7+2869.2i  -157.5+2892.6i  -159.3+2916i  -161.1+2939.4i  -162.9+2962.8i  -164.7+2986.2i  -166.5+3009.6i  -168.3+3033i  -170.1+3056.4i  -171.9+3079.8i  -173.7+3103.2i  -175.5+3126.6i  -177.3+3150i  -179.1+3173.4i  -180.9+3196.8i  -182.7+3220.2i  -184.5+3243.6i  -186.3+3267i  -188.1+3290.4i  -189.9+3313.8i  -191.7+3337.2i  -193.5+3360.6i  -195.3+3384i  -197.1+3407.4i  -198.9+3430.8i  -200.7+3454.2i  -202.5+3477.6i  -204.3+3501i  -206.1+3524.4i  -207.9+3547.8i  -209.7+3571.2i  -211.5+3594.6i  -213.3+3618i  -215.1+3641.4i  -216.9+3664.8i  -218.7+3688.2i  -220.5+3711.6i  -222.3+3735i  -224.1+3758.4i  -225.9+3781.8i  -227.7+3805.2i  -229.5+3828.6i  -231.3+3852i  -233.1+3875.4i  -234.9+3898.8i
                                     -123.3+2887.2i  -125.1+2917.8i  -126.9+2948.4i  -128.7+2979i  -130.5+3009.6i  -132.3+3040.2i  -134.1+3070.8i  -135.9+3101.4i  -137.7+3132i  -139.5+3162.6i  -141.3+3193.2i  -143.1+3223.8i  -144.9+3254.4i  -146.7+3285i  -148.5+3315.6i  -150.3+3346.2i  -152.1+3376.8i  -153.9+3407.4i  -155.7+3438i  -157.5+3468.6i  -159.3+3499.2i  -161.1+3529.8i  -162.9+3560.4i  -164.7+3591i  -166.5+3621.6i  -168.3+3652.2i  -170.1+3682.8i  -171.9+3713.4i  -173.7+3744i  -175.5+3774.6i  -177.3+3805.2i  -179.1+3835.8i  -180.9+3866.4i  -182.7+3897i  -184.5+3927.6i  -186.3+3958.2i  -188.1+3988.8i  -189.9+4019.4i  -191.7+4050i  -193.5+4080.6i  -195.3+4111.2i  -197.1+4141.8i  -198.9+4172.4i  -200.7+4203i  -202.5+4233.6i  -204.3+4264.2i  -206.1+4294.8i  -207.9+4325.4i  -209.7+4356i  -211.5+4386.6i  -213.3+4417.2i  -215.1+4447.8i  -216.9+4478.4i  -218.7+4509i  -220.5+4539.6i  -222.3+4570.2i  -224.1+4600.8i  -225.9+4631.4i  -227.7+4662i  -229.5+4692.6i  -231.3+4723.2i  -233.1+4753.8i  -234.9+4784.4i  -236.7+4815i
                                     -125.1+3349.8i  -126.9+3387.6i  -128.7+3425.4i  -130.5+3463.2i  -132.3+3501i  -134.1+3538.8i  -135.9+3576.6i  -137.7+3614.4i  -139.5+3652.2i  -141.3+3690i  -143.1+3727.8i  -144.9+3765.6i  -146.7+3803.4i  -148.5+3841.2i  -150.3+3879i  -152.1+3916.8i  -153.9+3954.6i  -155.7+3992.4i  -157.5+4030.2i  -159.3+4068i  -161.1+4105.8i  -162.9+4143.6i  -164.7+4181.4i  -166.5+4219.2i  -168.3+4257i  -170.1+4294.8i  -171.9+4332.6i  -173.7+4370.4i  -175.5+4408.2i  -177.3+4446i  -179.1+4483.8i  -180.9+4521.6i  -182.7+4559.4i  -184.5+4597.2i  -186.3+4635i  -188.1+4672.8i  -189.9+4710.6i  -191.7+4748.4i  -193.5+4786.2i  -195.3+4824i  -197.1+4861.8i  -198.9+4899.6i  -200.7+4937.4i  -202.5+4975.2i  -204.3+5013i  -206.1+5050.8i  -207.9+5088.6i  -209.7+5126.4i  -211.5+5164.2i  -213.3+5202i  -215.1+5239.8i  -216.9+5277.6i  -218.7+5315.4i  -220.5+5353.2i  -222.3+5391i  -224.1+5428.8i  -225.9+5466.6i  -227.7+5504.4i  -229.5+5542.2i  -231.3+5580i  -233.1+5617.8i  -234.9+5655.6i  -236.7+5693.4i  -238.5+5731.2i
```

## License

This work is dual-licensed under MIT and GPL 3.0 (or any later version).
You can choose between one of them if you use this work.

`SPDX-License-Identifier: MIT OR GPL-3.0-or-later`
